# Task 1: Port `initialize_project()` from CDD POC

**Estimated Time:** 2 hours
**Status:** Planning Complete, Ready to Implement

---

## Overview

Port the `initialize_project()` function from CDD POC to CDD Agent with specific adaptations for our architecture.

**Source:** `/home/guilherme/code/context-driven-documentation/src/cddoc/init.py`
**Destination:** `/home/guilherme/code/cdd-agent-cli/src/cdd_agent/mechanical/init.py`

---

## Key Changes from CDD POC

### 1. Create `CDD.md` (not `CLAUDE.md`)

**Implementation:**

```python
def generate_cdd_md(base_path: Path, force: bool = False) -> tuple[bool, bool]:
    """Generate CDD.md from constitution template.

    If CLAUDE.md exists, ask user if content should be migrated.

    Returns:
        Tuple of (created, migrated)
    """
    cdd_md_path = base_path / "CDD.md"
    claude_md_path = base_path / "CLAUDE.md"

    # Case 1: CDD.md already exists
    if cdd_md_path.exists() and not force:
        return (False, False)  # Skip, already have CDD.md

    # Case 2: CLAUDE.md exists (Claude Code project)
    if claude_md_path.exists():
        console.print("[yellow]ğŸ“„ Found existing CLAUDE.md[/yellow]")

        migrate = prompt_yes_no(
            "Migrate content from CLAUDE.md to CDD.md?",
            default=True
        )

        if migrate:
            # Copy content from CLAUDE.md to CDD.md
            content = claude_md_path.read_text()
            cdd_md_path.write_text(content)
            console.print("âœ… Content migrated from CLAUDE.md â†’ CDD.md")
            console.print("ğŸ’¡ You can now delete CLAUDE.md if desired")
            return (True, True)  # Created via migration
        else:
            # User said no - create from template
            pass  # Fall through to template creation

    # Case 3: Neither exists - create from template
    template_path = base_path / ".cdd" / "templates" / "constitution-template.md"

    if template_path.exists():
        shutil.copy2(template_path, cdd_md_path)
        return (True, False)  # Created from template

    return (False, False)
```

**Behavior:**
- âœ… Always creates/uses `CDD.md` (our standard)
- âœ… Detects existing `CLAUDE.md` and offers migration
- âœ… User can decline migration and start fresh
- âœ… Helpful message about cleaning up old `CLAUDE.md`

---

### 2. Skip `.claude/commands/` Installation

```python
# âŒ DON'T DO THIS (from CDD POC)
# installed_commands = install_framework_commands(target_path, language)

# âœ… DO THIS (CDD Agent)
# Nothing - slash commands come from package installation, not init
```

**Key Understanding:**
- **Installation time** (`pip install cdd-agent`): User gets slash commands as part of the Python package
- **Initialization time** (`/init`): User gets project structure (directories, templates, CDD.md)
- **Runtime** (`cdd-agent chat`): Slash commands loaded from `src/cdd_agent/slash_commands.py` (internal code)

**No external files needed!**

---

### 3. English-Only for Now

```python
# âŒ DON'T DO THIS (from CDD POC)
# language = prompt_language_selection()  # Bilingual prompt

# âœ… DO THIS (CDD Agent v0.2.0)
language = "en"  # Hardcoded

# Write to config
create_config_file(target_path, language="en")
```

**`.cdd/config.yaml` content:**
```yaml
# CDD Framework Configuration
# Generated by: cdd-agent init

# Language preference
# Supported values: en (more languages in future versions)
language: en

# Config schema version
version: 1
```

**Future:** Add `prompt_language_selection()` back when we have Portuguese templates.

---

### 4. Templates from CDD Agent Package

```python
def install_templates(base_path: Path, language: str = "en") -> List[str]:
    """Install templates from package to .cdd/templates/"""

    # Get source templates from package
    package_dir = Path(__file__).parent  # src/cdd_agent/mechanical/
    source_templates = package_dir / "templates" / language

    if not source_templates.exists():
        raise InitializationError(
            f"Templates not found for language: {language}"
        )

    # Target: .cdd/templates/
    target_templates = base_path / ".cdd" / "templates"
    target_templates.mkdir(parents=True, exist_ok=True)

    installed = []

    # Copy all template files
    for template_file in source_templates.glob("*"):
        if template_file.is_file():
            target_file = target_templates / template_file.name
            shutil.copy2(template_file, target_file)
            installed.append(f".cdd/templates/{template_file.name}")

    return installed
```

**Package structure:**
```
src/cdd_agent/mechanical/
â”œâ”€â”€ init.py
â””â”€â”€ templates/
    â””â”€â”€ en/
        â”œâ”€â”€ feature-ticket-template.yaml
        â”œâ”€â”€ bug-ticket-template.yaml
        â”œâ”€â”€ spike-ticket-template.yaml
        â”œâ”€â”€ feature-plan-template.md
        â”œâ”€â”€ bug-plan-template.md
        â”œâ”€â”€ spike-plan-template.md
        â”œâ”€â”€ constitution-template.md
        â”œâ”€â”€ guide-doc-template.md
        â””â”€â”€ feature-doc-template.md
```

**Installed to user's project:**
```
project/.cdd/templates/
â”œâ”€â”€ feature-ticket-template.yaml
â”œâ”€â”€ bug-ticket-template.yaml
â”œâ”€â”€ spike-ticket-template.yaml
â”œâ”€â”€ feature-plan-template.md
â”œâ”€â”€ bug-plan-template.md
â”œâ”€â”€ spike-plan-template.md
â”œâ”€â”€ constitution-template.md
â”œâ”€â”€ guide-doc-template.md
â””â”€â”€ feature-doc-template.md
```

---

## Functions to Port

From CDD POC `init.py`, port these functions:

### Port Unchanged (6 functions)

1. âœ… **`validate_path(path: Path) -> Path`**
   - Check dangerous paths
   - Verify write permissions
   - Return absolute path

2. âœ… **`is_dangerous_path(path: Path) -> bool`**
   - Check against DANGEROUS_PATHS list
   - Check if home directory

3. âœ… **`get_git_root(path: Path) -> Path | None`**
   - Run `git rev-parse --show-toplevel`
   - Return git root or None

4. âœ… **`check_existing_structure(base_path: Path) -> Tuple[bool, List[str]]`**
   - Scan for existing CDD directories
   - Return (has_structure, existing_items)

5. âœ… **`create_directory_structure(base_path: Path) -> List[str]`**
   - Create all directories
   - Add .gitkeep to user-facing dirs
   - Return list of created dirs

6. âœ… **`create_config_file(target_path: Path, language: str)`**
   - Write `.cdd/config.yaml` with language preference
   - **Simplified:** Always use language="en"

### Port with Modifications (2 functions)

7. âœ… **`install_templates(base_path: Path, language: str) -> List[str]`**
   - **Simplified:** No language prompt (hardcode "en")
   - Copy templates from package to `.cdd/templates/`

8. âœ… **`generate_cdd_md(base_path: Path, force: bool) -> tuple[bool, bool]`**
   - **MODIFIED:** Migration logic from CLAUDE.md
   - Returns (created, migrated) tuple

### Remove (Not Needed)

- âŒ **`install_framework_commands()`** - Slash commands are internal
- âŒ **`prompt_language_selection()`** - English-only for now

### New Helper Function

9. âœ… **`prompt_yes_no(question: str, default: bool = True) -> bool`**

```python
def prompt_yes_no(question: str, default: bool = True) -> bool:
    """Prompt user for yes/no answer.

    Args:
        question: Question to ask
        default: Default answer if user presses Enter

    Returns:
        True for yes, False for no
    """
    from rich.console import Console
    console = Console()

    default_str = "Y/n" if default else "y/N"

    while True:
        response = console.input(f"{question} [{default_str}]: ").strip().lower()

        if not response:
            return default

        if response in ("y", "yes"):
            return True
        elif response in ("n", "no"):
            return False
        else:
            console.print("[yellow]Please answer 'y' or 'n'[/yellow]")
```

---

## Main Function Signature

```python
def initialize_project(path: str, force: bool = False) -> dict:
    """Initialize CDD structure in a project.

    Creates:
    - CDD.md (project constitution)
    - specs/tickets/ (temporary work)
    - docs/features/ (living documentation)
    - docs/guides/ (user guides)
    - .cdd/templates/ (internal templates)
    - .cdd/config.yaml (language configuration)

    Args:
        path: Target directory path
        force: Whether to overwrite existing files

    Returns:
        Dictionary with initialization results:
        {
            "path": Path,                    # Absolute path where initialized
            "created_dirs": List[str],       # Directories created
            "installed_templates": List[str],# Template files installed
            "cdd_md_created": bool,          # Whether CDD.md was created
            "cdd_md_migrated": bool,         # Whether migrated from CLAUDE.md
            "existing_structure": bool,      # Whether partial structure existed
            "language": str                  # Language used ("en")
        }

    Raises:
        InitializationError: If initialization fails
    """
```

---

## Return Value

```python
return {
    "path": target_path,                # Path("/home/user/my-project")
    "created_dirs": created_dirs,       # ["specs/tickets/", "docs/features/", ...]
    "installed_templates": templates,   # [".cdd/templates/feature-ticket-template.yaml", ...]
    "cdd_md_created": cdd_md_created,   # True if created/migrated
    "cdd_md_migrated": migrated,        # True if migrated from CLAUDE.md
    "existing_structure": has_existing, # True if partial structure existed
    "language": "en"
}
```

---

## Directory Structure Created

```
project/
â”œâ”€â”€ CDD.md                       # Project constitution (from template or migrated)
â”œâ”€â”€ specs/
â”‚   â””â”€â”€ tickets/                 # Ticket workspace
â”‚       â””â”€â”€ .gitkeep
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ features/                # Living feature documentation
â”‚   â”‚   â””â”€â”€ .gitkeep
â”‚   â””â”€â”€ guides/                  # User guides
â”‚       â””â”€â”€ .gitkeep
â””â”€â”€ .cdd/
    â”œâ”€â”€ config.yaml              # Configuration (language: en)
    â””â”€â”€ templates/               # Template files
        â”œâ”€â”€ feature-ticket-template.yaml
        â”œâ”€â”€ bug-ticket-template.yaml
        â”œâ”€â”€ spike-ticket-template.yaml
        â”œâ”€â”€ feature-plan-template.md
        â”œâ”€â”€ bug-plan-template.md
        â”œâ”€â”€ spike-plan-template.md
        â”œâ”€â”€ constitution-template.md
        â”œâ”€â”€ guide-doc-template.md
        â””â”€â”€ feature-doc-template.md
```

---

## Expected User Experiences

### Scenario 1: Fresh Project (No existing files)

```bash
$ cdd-agent chat
> /init

Initializing CDD project structure...

âœ… CDD project initialized!

Created:
  ğŸ“ specs/tickets/
  ğŸ“ docs/features/
  ğŸ“ docs/guides/
  ğŸ“„ CDD.md
  âš™ï¸  .cdd/templates/ (9 templates installed)

Next steps:
  1. Edit CDD.md with your project information
  2. Create your first ticket: /new feature <name>
```

### Scenario 2: Claude Code Project (CLAUDE.md exists)

```bash
$ cdd-agent chat
> /init

Initializing CDD project structure...

ğŸ“„ Found existing CLAUDE.md

Migrate content from CLAUDE.md to CDD.md? [Y/n]: y

âœ… Content migrated from CLAUDE.md â†’ CDD.md
ğŸ’¡ You can now delete CLAUDE.md if desired

âœ… CDD project initialized!

Created:
  ğŸ“ specs/tickets/
  ğŸ“ docs/features/
  ğŸ“ docs/guides/
  ğŸ“„ CDD.md (migrated from CLAUDE.md)
  âš™ï¸  .cdd/templates/ (9 templates installed)
```

### Scenario 3: Partial CDD Structure Exists

```bash
$ cdd-agent chat
> /init

Initializing CDD project structure...

âš ï¸  CDD structure partially exists. Creating missing items only.

âœ… CDD project initialized!

Created:
  ğŸ“ docs/guides/ (was missing)
  âš™ï¸  .cdd/templates/ (updated templates)

Existing structure preserved:
  ğŸ“ specs/tickets/ âœ…
  ğŸ“ docs/features/ âœ…
  ğŸ“„ CDD.md âœ…
```

---

## Implementation Checklist

### Step 1: Create Directory Structure
- [ ] Create `src/cdd_agent/mechanical/` directory
- [ ] Create `src/cdd_agent/mechanical/__init__.py`
- [ ] Create `src/cdd_agent/mechanical/init.py`

### Step 2: Copy Templates
- [ ] Create `src/cdd_agent/mechanical/templates/en/` directory
- [ ] Copy templates from CDD POC:
  - [ ] `feature-ticket-template.yaml`
  - [ ] `bug-ticket-template.yaml`
  - [ ] `spike-ticket-template.yaml`
  - [ ] `feature-plan-template.md`
  - [ ] `bug-plan-template.md`
  - [ ] `spike-plan-template.md`
  - [ ] `constitution-template.md`
  - [ ] `guide-doc-template.md`
  - [ ] `feature-doc-template.md`

### Step 3: Port Functions
- [ ] Port `validate_path()`
- [ ] Port `is_dangerous_path()`
- [ ] Port `get_git_root()`
- [ ] Port `check_existing_structure()`
- [ ] Port `create_directory_structure()`
- [ ] Port `install_templates()` (simplified)
- [ ] Port `create_config_file()` (simplified)
- [ ] Create `prompt_yes_no()` (new helper)
- [ ] Create `generate_cdd_md()` (modified with migration)

### Step 4: Implement Main Function
- [ ] Implement `initialize_project()`
- [ ] Add proper error handling
- [ ] Add InitializationError exception class
- [ ] Add return value formatting

### Step 5: Testing
- [ ] Test fresh project initialization
- [ ] Test CLAUDE.md migration (accept)
- [ ] Test CLAUDE.md migration (decline)
- [ ] Test partial structure detection
- [ ] Test dangerous path rejection
- [ ] Test git root detection
- [ ] Test idempotency (run twice)
- [ ] Test force flag

---

## Constants

```python
# Dangerous system paths that should never be initialized
DANGEROUS_PATHS = [
    "/",
    "/usr",
    "/etc",
    "/bin",
    "/sbin",
    "/var",
    "/sys",
    "/proc",
    "/boot",
]
```

---

## Exception Class

```python
class InitializationError(Exception):
    """Raised when initialization cannot proceed."""
    pass
```

---

## Dependencies

```python
import os
import shutil
import subprocess
from pathlib import Path
from typing import List, Tuple

from rich.console import Console

console = Console()
```

---

## Success Criteria

- âœ… `initialize_project()` creates full directory structure
- âœ… Creates `CDD.md` (not `CLAUDE.md`)
- âœ… Migrates from `CLAUDE.md` when detected
- âœ… Installs 9 templates to `.cdd/templates/`
- âœ… Refuses dangerous paths (/, /usr, /home, etc.)
- âœ… Detects and uses git root
- âœ… Creates `.gitkeep` files in empty directories
- âœ… Idempotent (safe to run multiple times)
- âœ… Returns correct result dictionary
- âœ… Handles errors gracefully
- âœ… English-only (language="en")

---

## Notes

- This is the foundation for the entire mechanical layer
- Once complete, `/init` slash command will call this function
- Templates copied here will be used by `/new` command (Task 2)
- Migration logic ensures smooth transition from Claude Code projects

---

**Status:** Ready to implement
**Next:** Begin implementation following this plan
